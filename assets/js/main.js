/* ========= i18n ========= */
const I18N = {
  pl: {
    nav_portfolio: "Przykłady prac",
    nav_pricing: "Cennik",
    nav_contact: "Kontakt",

    hero_kicker: "Inki Graphics • Amazon Design",
    hero_h1: "Grafiki na Amazon, które budują zaufanie klientów",
    hero_p: "-- nowoczesne: A+ Content, Infografiki i Rendery 3D — spójny i czytelny design dopasowany do Twojej marki i wymagań Amazon.",
    hero_b1: "Komunikacja oparta na briefie - bez chaosu",
    hero_b2: "Wersja mobilna w cenie",
    hero_b3: "Pliki gotowe do wdrożenia na Amazon",
    cta_brief_pl: "BRIEF PO POLSKU",
    cta_brief_en: "BRIEF IN ENGLISH",
    cta_email: "NAPISZ NA E_MAIL",

    banner_hint_left: "Miejsce na animowany banner 21:9",
    banner_hint_right: "GIF ładuje się dopiero, gdy jest widoczny",

    portfolio_h2: "Przykłady prac",
    portfolio_small: "Kliknij kategorię, aby otworzyć galerię (5 przykładów)",
    cat_listing: "Listing Images",
    cat_aplus_premium: "A+ Content Premium",
    cat_aplus_basic: "A+ Content Basic",
    cat_brand_story: "Brand Story",
    cat_renders_3d: "Rendery 3D",
    cat_meta: "Portfolio",

    pricing_h2: "Cennik",
    pricing_small: "-- dla stałych klientów, poczawszy od 3 zamówienia.",
    price_listing: "Listing Images",
    price_aplus_basic: "A+ Content Basic (5 grafik)",
    price_aplus_premium: "A+ Content Premium (7 grafik + wersja mobilna)",
    price_brand_story: "Brand Story (5 grafik + wersja mobilna)",
    price_fixes: "Poprawki po drugiej rundzie",
    price_translation: "Tłumaczenie tekstów (grafika)",
    pricing_note: "Ostateczna wycena jest przekazywana drogą mailową.",

    process_title: "Proces współpracy",
    process_text: "brief → wycena → projekt → poprawki (2 rundy w cenie) → dostarczenie plików",

    contact_h2: "Kontakt",
    contact_p: "contact@inki-graphics.com",
    contact_btn: "NAPISZ NA E_MAIL",

    firms: "Zaufali mi:",

    footer_company: "Ina Kabiak — Inki Graphics (JDG)",
    footer_nip: "NIP: 5243009618",
    footer_regon: "REGON: 542196495",
    footer_email: "E-mail: contact@inki-graphics.com",
    footer_cookie_settings: "Zmień ustawienia cookies",
    footer_note: "Infografiki na Amazon tworzę z miłością ❤️ na podstawie zdjęć od klienta lub na bazie renderów 3D.",


    legal_privacy: "Polityka prywatności",
    legal_cookies: "Cookies",
    legal_terms: "Regulamin",

    modal_close: "X",
    slider_prev: "←",
    slider_next: "→",
    slider_counter: "Obraz {x} / {n}",

    cookie_title: "Cookies i prywatność",
    cookie_text:
      "-- używamy plików cookies. Niezbędne cookies są wymagane do działania strony. Analityczne i marketingowe uruchamiamy dopiero po Twojej zgodzie.",
    cookie_accept: "Akceptuj wszystkie",
    cookie_necessary: "Akceptuj tylko niezbędne",
    cookie_settings: "Ustawienia",
    cookie_settings_title: "Ustawienia cookies",
    cookie_necessary_label: "Niezbędne",
    cookie_necessary_desc: "Zawsze aktywne — podstawowe działanie strony.",
    cookie_analytics_label: "Analityczne (Google Analytics)",
    cookie_analytics_desc: "Pomagają zrozumieć ruch na stronie.",
    cookie_marketing_label: "Marketingowe (Meta Pixel)",
    cookie_marketing_desc: "Pomagają mierzyć skuteczność reklam.",
    cookie_save: "Zapisz wybór"
  },

  en: {
    nav_portfolio: "Portfolio",
    nav_pricing: "Pricing",
    nav_contact: "Contact",

    hero_kicker: "Inki Graphics • Amazon Design",
    hero_h1: "Amazon graphics that build customer trust ",
    hero_p: "-- modern A+ Content, Infographics and 3D renders — clean, premium visuals aligned with your brand and Amazon guidelines.",
    hero_b1: "Brief-based communication — no chaos",
    hero_b2: "Mobile version included",
    hero_b3: "Ready-to-upload Amazon files",
    cta_brief_pl: "BRIEF PO POLSKU",
    cta_brief_en: "BRIEF IN ENGLISH",
    cta_email: "EMAIL ME",

    banner_hint_left: "Animated banner placeholder 21:9",
    banner_hint_right: "GIF loads only when visible",

    portfolio_h2: "Portfolio",
    portfolio_small: "Click a category to open the gallery (5 examples)",
    cat_listing: "Listing Images",
    cat_aplus_premium: "A+ Content Premium",
    cat_aplus_basic: "A+ Content Basic",
    cat_brand_story: "Brand Story",
    cat_renders_3d: "3D renders",
    cat_meta: "5 examples",

    pricing_h2: "Pricing",
    pricing_small: "-- for returning clients (from the 3rd order)",
    price_listing: "Listing Images",
    price_aplus_basic: "A+ Content Basic (5 graphics)",
    price_aplus_premium: "A+ Content Premium (7 graphics + mobile version)",
    price_brand_story: "Brand Story (5 graphics)",
    price_fixes: "Edits after the second round",
    price_translation: "Text translation (for infographics)",
    pricing_note: "Final quote is provided by email only.",

    process_title: "Workflow",
    process_text: "brief → quote → design → edits (2 rounds included) → delivery",

    contact_h2: "Contact",
    contact_p: "contact@inki-graphics.com",
    contact_btn: "Email me",

    firms: "Trusted by:",

    footer_company: "Ina Kabiak — Inki Graphics (sole proprietorship)",
    footer_nip: "NIP: 5243009618",
    footer_regon: "REGON: 542196495",
    footer_email: "Email: contact@inki-graphics.com",
    footer_cookie_settings: "Cookie settings",
    footer_note: "Infographics are created with love ❤️ using the client’s photos or 3D renders.",

    legal_privacy: "Privacy Policy",
    legal_cookies: "Cookies",
    legal_terms: "Terms & Conditions",

    modal_close: "Close",
    slider_prev: "←",
    slider_next: "→",
    slider_counter: "Image {x} / {n}",

    cookie_title: "Cookies & privacy",
    cookie_text:
      "This site uses cookies. Necessary cookies are required for the site to function. Analytics (Google Analytics) and marketing (Meta Pixel) are enabled only after your consent.",
    cookie_accept: "Accept all",
    cookie_necessary: "Accept necessary only",
    cookie_settings: "Settings",
    cookie_settings_title: "Cookie settings",
    cookie_necessary_label: "Necessary",
    cookie_necessary_desc: "Always on — basic site operation.",
    cookie_analytics_label: "Analytics (Google Analytics)",
    cookie_analytics_desc: "Helps understand website traffic.",
    cookie_marketing_label: "Marketing (Meta Pixel)",
    cookie_marketing_desc: "Helps measure ads performance.",
    cookie_save: "Save selection"
  }
};

const LANG_KEY = "inki_lang";
const CONSENT_KEY = "inki_cookie_consent_v1"; // { necessary:true, analytics:false, marketing:false }
let currentLang = localStorage.getItem(LANG_KEY) || "pl";

/* ========= Portfolio config ========= */
const PORTFOLIO = {
  listing: {
    titleKey: "cat_listing",
    folder: "assets/img/portfolio/listing",
    files: ["1.jpg","2.jpg","3.jpg","4.jpg","5.jpg","6.jpg","7.jpg","8.jpg","9.jpg","10.jpg","11.jpg","12.jpg","13.jpg","14.jpg","15.jpg","16.jpg","17.jpg","18.jpg","19.jpg","20.jpg","21.jpg"]
  },
  aplus_premium: {
    titleKey: "cat_aplus_premium",
    folder: "assets/img/portfolio/aplus-premium",
    files: ["1.jpg","2.jpg","3.jpg","4.jpg"]
  },
  aplus_basic: {
    titleKey: "cat_aplus_basic",
    folder: "assets/img/portfolio/aplus-basic",
    files: ["1.jpg","2.jpg","3.jpg"]
  },
  brand_story: {
    titleKey: "cat_brand_story",
    folder: "assets/img/portfolio/brand-story",
    files: ["1.png","2.png","3.png","4.png","5.png", "6.png"]
  },
  renders_3d: {
    titleKey: "cat_renders_3d",
    folder: "assets/img/portfolio/renders-3d",
    files: ["1.jpg","2.jpg","3.jpg","4.jpg","5.jpg","6.jpg","7.jpg","8.jpg","9.jpg","10.jpg"]
  }
};

/* ========= Helpers ========= */
function t(key, vars = {}) {
  const dict = I18N[currentLang] || I18N.pl;
  let s = dict[key] ?? key;
  Object.entries(vars).forEach(([k,v]) => { s = s.replaceAll(`{${k}}`, String(v)); });
  return s;
}

function applyI18n() {
  document.documentElement.lang = currentLang;

  // update nav labels
  document.querySelectorAll("[data-nav]").forEach(a => {
    a.textContent = t(a.getAttribute("data-nav"));
  });

  // generic text nodes
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });

  // hero title split
  const heroH1Base = document.querySelector("[data-i18n-hero-h1]");
  if (heroH1Base) heroH1Base.textContent = t("hero_h1");


  // portfolio tiles
  document.querySelectorAll("[data-portfolio-tile]").forEach(tile => {
    const id = tile.getAttribute("data-portfolio-tile");
    const cfg = PORTFOLIO[id];
    if (!cfg) return;
    tile.querySelector(".tile__title").textContent = t(cfg.titleKey);
    const meta = tile.querySelector(".tile__meta");
if (meta) meta.textContent = t("cat_meta");

refreshCookieUI();
  });



  // legal page title + content (if present)
  const legalTitle = document.querySelector("[data-legal-title]");
  if (legalTitle) {
    const page = document.body.getAttribute("data-page");
    const map = { privacy: "legal_privacy", cookies: "legal_cookies", terms: "legal_terms" };
    legalTitle.textContent = t(map[page] || "legal_privacy");
  }

  const lc = document.getElementById("legalContent");
  if (lc && window.__LEGAL) {
    lc.innerHTML = window.__LEGAL[currentLang] || window.__LEGAL.pl;
  }
}


function setLang(lang) {
  currentLang = (lang === "en") ? "en" : "pl";
  localStorage.setItem(LANG_KEY, currentLang);
  applyI18n();
  refreshCookieUI()
}



function qs(sel, root=document){ return root.querySelector(sel); }
function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

/* ========= Banner lazy-load + reduced motion ========= */
function initBanner() {
  const img = qs("#heroBanner");
  if (!img) return;

  const reduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
  const gifSrc = img.getAttribute("data-gif");
  const staticSrc = img.getAttribute("data-static");

  if (reduced) {
    img.src = staticSrc;
    img.style.display = "block";
    return;
  }

  let loadedOnce = false;
  const io = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting && !loadedOnce) {
        loadedOnce = true;
        img.src = gifSrc;          // GIF loads only when visible
        img.style.display = "block";
        io.disconnect();
      }
    });
  }, { threshold: 0.35 });

  io.observe(img);
}

/* ========= Portfolio modal + gallery ========= */
let galleryState = { images: [], title: "" };

function openModal(id) {
  const modal = qs("#portfolioModal");
  if (!modal) return;

  const cfg = PORTFOLIO[id];
  if (!cfg) return;

  galleryState.images = cfg.files.map(f => `${cfg.folder}/${f}`);
  galleryState.title = t(cfg.titleKey);

  const titleEl = qs("#portfolioModalTitle");
  if (titleEl) titleEl.textContent = galleryState.title;

  const gallery = qs("#portfolioGallery");
if (gallery) {
  gallery.innerHTML = galleryState.images.map((src, i) => `
    <button type="button" class="portfolio-gallery__item" aria-label="Preview image ${i+1}">
      <img src="${src}" loading="lazy" decoding="async" alt="Portfolio image ${i+1}">
    </button>
  `).join("");
  gallery.scrollTop = 0;
}

  modal.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
  qs("#modalCloseBtn")?.focus();
}

function closeModal() {
  const modal = qs("#portfolioModal");
  if (!modal) return;

  modal.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";

  const gallery = qs("#portfolioGallery");
  if (gallery) gallery.innerHTML = "";

  document.getElementById("pressZoomOverlay")?.classList.remove("is-open");

  closeZoom();
}

/* ========= Cookie consent with GA/Meta blocking ========= */
function getConsent() {
  try {
    const raw = localStorage.getItem(CONSENT_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch { return null; }
}
function setConsent(consentObj) {
  localStorage.setItem(CONSENT_KEY, JSON.stringify(consentObj));
  hideCookieBanner();
  maybeLoadTrackers(consentObj);
}
function showCookieBanner() {
  const el = qs("#cookieBanner");
  if (!el) return;
  el.style.display = "block";
}
function hideCookieBanner() {
  const el = qs("#cookieBanner");
  if (!el) return;
  el.style.display = "none";
}

function refreshCookieUI() {
  const title = qs("[data-cookie-title]");
  const text = qs("[data-cookie-text]");
  const btnAccept = qs("[data-cookie-accept]");
  const btnNecessary = qs("[data-cookie-necessary]");
  const btnSettings = qs("[data-cookie-settings]");

  if (title) title.textContent = t("cookie_title");
  if (text) text.textContent = t("cookie_text");
  if (btnAccept) btnAccept.textContent = t("cookie_accept");
  if (btnNecessary) btnNecessary.textContent = t("cookie_necessary");
  if (btnSettings) btnSettings.textContent = t("cookie_settings");

  const stTitle = qs("[data-cookie-settings-title]");
  if (stTitle) stTitle.textContent = t("cookie_settings_title");

  const nLabel = qs("[data-toggle-necessary-label]");
  const nDesc  = qs("[data-toggle-necessary-desc]");
  const aLabel = qs("[data-toggle-analytics-label]");
  const aDesc  = qs("[data-toggle-analytics-desc]");
  const mLabel = qs("[data-toggle-marketing-label]");
  const mDesc  = qs("[data-toggle-marketing-desc]");
  const saveBtn = qs("[data-cookie-save]");

  if (nLabel) nLabel.textContent = t("cookie_necessary_label");
  if (nDesc)  nDesc.textContent  = t("cookie_necessary_desc");
  if (aLabel) aLabel.textContent = t("cookie_analytics_label");
  if (aDesc)  aDesc.textContent  = t("cookie_analytics_desc");
  if (mLabel) mLabel.textContent = t("cookie_marketing_label");
  if (mDesc)  mDesc.textContent  = t("cookie_marketing_desc");
  if (saveBtn) saveBtn.textContent = t("cookie_save");
}

function maybeLoadTrackers(consentObj) {
  if (!consentObj) return;

  // IMPORTANT: placeholders. Insert your real IDs later.
  const GA4_ID = "G-XXXXXXXXXX";        // <- put GA4 Measurement ID here
  const META_PIXEL_ID = "000000000000"; // <- put Meta Pixel ID here

  if (consentObj.analytics) loadGA4(GA4_ID);
  if (consentObj.marketing) loadMetaPixel(META_PIXEL_ID);
}

let gaLoaded = false;
function loadGA4(measurementId) {
  if (gaLoaded) return;
  if (!measurementId || measurementId.includes("XXXX")) return;
  gaLoaded = true;

  const s1 = document.createElement("script");
  s1.async = true;
  s1.src = `https://www.googletagmanager.com/gtag/js?id=${encodeURIComponent(measurementId)}`;
  document.head.appendChild(s1);

  const s2 = document.createElement("script");
  s2.text = `
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', '${measurementId}', { anonymize_ip: true });
  `;
  document.head.appendChild(s2);
}

let metaLoaded = false;
function loadMetaPixel(pixelId) {
  if (metaLoaded) return;
  if (!pixelId || pixelId === "000000000000") return;
  metaLoaded = true;

  const s = document.createElement("script");
  s.text = `
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '${pixelId}');
    fbq('track', 'PageView');
  `;
  document.head.appendChild(s);

  const nos = document.createElement("noscript");
  nos.innerHTML = `<img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=${pixelId}&ev=PageView&noscript=1" />`;
  document.body.appendChild(nos);
}

function openCookieSettings() {
  refreshCookieUI();
  const modal = qs("#cookieSettingsModal");
  if (!modal) return;

  const consent = getConsent() || { necessary: true, analytics: false, marketing: false };
  qs("#toggleAnalytics").checked = !!consent.analytics;
  qs("#toggleMarketing").checked = !!consent.marketing;

  modal.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
  qs("#cookieSaveBtn").focus();
}
function closeCookieSettings() {
  const modal = qs("#cookieSettingsModal");
  if (!modal) return;
  modal.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
}

function initCookies() {
  const consent = getConsent();
  if (!consent) {
    showCookieBanner();
  } else {
    maybeLoadTrackers(consent);
  }

  // Banner buttons
  const accept = qs("#cookieAccept");
  const necessary = qs("#cookieNecessary");
  const settings = qs("#cookieSettings");

  accept?.addEventListener("click", () => setConsent({ necessary:true, analytics:true, marketing:true }));
  necessary?.addEventListener("click", () => setConsent({ necessary:true, analytics:false, marketing:false }));
  settings?.addEventListener("click", openCookieSettings);

  // Footer link
  const footerLink = qs("[data-open-cookie-settings]");
  footerLink?.addEventListener("click", (e) => { e.preventDefault(); openCookieSettings(); });

  // Settings modal actions
  qs("#cookieSettingsClose")?.addEventListener("click", closeCookieSettings);
  qs("#cookieSaveBtn")?.addEventListener("click", () => {
    const analytics = qs("#toggleAnalytics").checked;
    const marketing = qs("#toggleMarketing").checked;
    setConsent({ necessary:true, analytics, marketing });
    closeCookieSettings();
  });

  // Close modals on backdrop / ESC
  qsa("[data-modal]").forEach(modal => {
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        if (modal.id === "portfolioModal") closeModal();
        if (modal.id === "cookieSettingsModal") closeCookieSettings();
      }
    });
  });
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeModal();
      closeCookieSettings();
    }
  });
}

function openZoom(src){
  const overlay = qs("#zoomOverlay");
  const img = qs("#zoomImg");
  if (!overlay || !img) return;

  img.src = src;
  overlay.setAttribute("aria-hidden","false");
  document.body.style.overflow = "hidden";
}

function closeZoom(){
  const overlay = qs("#zoomOverlay");
  const img = qs("#zoomImg");
  if (!overlay || !img) return;

  overlay.setAttribute("aria-hidden","true");
  img.src = "";
  // если портфолио-модалка всё ещё открыта — скролл не возвращаем
  const portfolioModal = qs("#portfolioModal");
  const modalOpen = portfolioModal && portfolioModal.getAttribute("aria-hidden") === "false";
  if (!modalOpen) document.body.style.overflow = "";
}

/* ========= Init ========= */
document.addEventListener("DOMContentLoaded", () => {
  const btn = qs("#langBtn");
  btn?.addEventListener("click", () => setLang(currentLang === "pl" ? "en" : "pl"));

  document.querySelectorAll("[data-portfolio-tile]").forEach(tile => {
    tile.addEventListener("click", () => openModal(tile.getAttribute("data-portfolio-tile")));
    tile.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        openModal(tile.getAttribute("data-portfolio-tile"));
      }
    });
  });

  qs("#modalCloseBtn")?.addEventListener("click", closeModal);
  
  applyI18n();
  initBanner();
  refreshCookieUI();
  initCookies();
  

  initHoldPreviewOverlay(); // ✅ вот тут

  // Tap image to zoom (good for mobile)
  qs("#sliderImg")?.addEventListener("click", () => {
    const overlay = qs("#zoomOverlay");
    const isOpen = overlay && overlay.getAttribute("aria-hidden") === "false";
    if (isOpen) {
      closeZoom(); // второй тап закрывает
    } else {
      const src = qs("#sliderImg")?.src;
      if (src) openZoom(src);
    }
  });

  // Click anywhere on zoom overlay closes it
  qs("#zoomOverlay")?.addEventListener("click", closeZoom);

  // ESC closes zoom too
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeZoom();
  });

});


function initPressZoomOnGallery(){
  const gallery = document.getElementById("portfolioGallery");
  if (!gallery) return;

  const clear = () => {
    gallery.querySelectorAll(".is-pressing").forEach(el => el.classList.remove("is-pressing"));
  };

  gallery.addEventListener("pointerdown", (e) => {
    const item = e.target.closest(".portfolio-gallery__item");
    if (!item) return;

    item.classList.add("is-pressing");
    item.setPointerCapture?.(e.pointerId);
  });

  document.addEventListener("pointerup", clear, true);
  document.addEventListener("pointercancel", clear, true);
  window.addEventListener("blur", clear);
}

// Burger menu
const header = document.querySelector(".header");
const burgerBtn = document.getElementById("burgerBtn");
const mobileMenu = document.getElementById("mobileMenu");

function closeBurger(){
  header?.classList.remove("is-open");
  burgerBtn?.setAttribute("aria-expanded", "false");
  mobileMenu?.setAttribute("aria-hidden", "true");
}

burgerBtn?.addEventListener("click", () => {
  const isOpen = header.classList.toggle("is-open");
  burgerBtn.setAttribute("aria-expanded", isOpen ? "true" : "false");
  mobileMenu.setAttribute("aria-hidden", isOpen ? "false" : "true");
});

// закрывать при клике на пункт
mobileMenu?.addEventListener("click", (e) => {
  if (e.target.closest("a")) closeBurger();
});

// закрывать по ESC
window.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeBurger();
});

window.addEventListener("resize", () => {
  if (window.innerWidth > 820) closeBurger();
});


function initHoldPreviewOverlay(){
  const gallery = document.getElementById("portfolioGallery");
  if (!gallery) return;

  // создаём оверлей один раз
  let overlay = document.getElementById("pressZoomOverlay");
  if (!overlay){
    overlay = document.createElement("div");
    overlay.id = "pressZoomOverlay";
    overlay.className = "press-zoom-overlay";
    overlay.innerHTML = `<img alt="">`;
    document.body.appendChild(overlay);
  }

  const overlayImg = overlay.querySelector("img");

  const open = (src, alt="") => {
    overlayImg.src = src;
    overlayImg.alt = alt;
    overlay.classList.add("is-open");
  };

  const close = () => {
    overlay.classList.remove("is-open");
    setTimeout(() => {
      if (!overlay.classList.contains("is-open")) overlayImg.removeAttribute("src");
    }, 150);
  };

  // 1) TAP по миниатюре = открыть (и не закрывать сразу!)
  gallery.addEventListener("click", (e) => {
    const item = e.target.closest(".portfolio-gallery__item");
    if (!item) return;

    const img = item.querySelector("img");
    if (!img) return;

    e.preventDefault();

    const src = img.currentSrc || img.src;
    const isOpen = overlay.classList.contains("is-open");
    const same = overlayImg.src === src;

    // тап по той же картинке второй раз — закрыть
    if (isOpen && same) close();
    else open(src, img.alt || "");
  });

  // 2) TAP по оверлею = закрыть
  overlay.addEventListener("click", (e) => {
    e.preventDefault();
    close();
  });

  // 3) ESC = закрыть
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") close();
  });
}

